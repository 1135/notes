### ç®€ä»‹

[Web application firewall](https://en.wikipedia.org/wiki/Web_application_firewall)

å„å®¶WAFåŸç†ç ”ç©¶ [Awesome-WAF: ğŸ”¥ Everything awesome about web-application firewalls (WAF).](https://github.com/0xInfection/Awesome-WAF)

* Appliance - è®¾å¤‡ ç¡¬ä»¶WAF
  * Barracuda Networks WAF
  * Citrix Netscaler Application Firewall
  * F5 Big-IP ASM
  * Fortinet FortiWeb
  * Imperva SecureSphere
  * Penta Security WAPPLES
  * Radware AppWall
  * Sophos XG Firewall
* Cloud - äº‘WAF
  * Alibaba Cloud
  * Amazon Web Services AWS WAF
  * Cloudbric
  * Cloudflare
  * F5 Silverline
  * Fastly
  * Imperva Incapsula
  * Radware
* Open-source å¼€æºWAF
  * ModSecurity

### WEBåº”ç”¨-å®‰å…¨éƒ¨ç½²æ¶æ„

WAFçš„åŸºç¡€æ¶æ„ï¼šä¸²è”(ä¼šè¯é“¾è·¯)ã€æ—è·¯(æ— æ³•é˜»æ–­)

ä¸²è”
```
é«˜é˜²IPï¼ˆDDoSé˜²æŠ¤ï¼‰ ->  CDNï¼ˆé™æ€èµ„æºåŠ é€Ÿï¼‰ -> Webåº”ç”¨é˜²ç«å¢™ï¼ˆä¸­é—´å±‚ï¼Œåº”ç”¨å±‚é˜²æŠ¤ï¼‰ -> æºç«™ï¼ˆECS/SLB/VPC/IDCâ€¦ï¼‰
```

ç¼ºçœä»»ä½•äº§å“æ—¶é¡ºåºä¸å˜ å¦‚:

ç¼ºå°‘WAFæ—¶çš„æ¶æ„ä¸ºï¼š`é«˜é˜²IP -> CDN -> ECS`

ç¼ºå°‘CDNæ—¶çš„æ¶æ„ä¸ºï¼š`é«˜é˜²IP -> WAF -> ECS`

**å…·ä½“é…ç½®æ­¥éª¤**:
* 1ã€é…ç½®Webåº”ç”¨é˜²ç«å¢™ï¼Œåœ¨æºç«™IPä¸­å¡«å†™SLBå…¬ç½‘IPã€ECSå…¬ç½‘IPæˆ–æœ¬åœ°æœåŠ¡å™¨IPï¼Œå¹¶åœ¨"æ˜¯å¦å·²ä½¿ç”¨äº†é«˜é˜²ã€CDNã€äº‘åŠ é€Ÿç­‰ä»£ç†ï¼Ÿ" é€‰é¡¹ä¸­é€‰æ‹©æ˜¯ã€‚
  * è¯¥æ­¥éª¤å¾—åˆ°äº† WAFæä¾›çš„`CNAME`
* 2ã€é…ç½®CDNï¼ˆå¦‚æœæœªå¯ç”¨CDNåˆ™è·³è¿‡æ­¤æ­¥éª¤ï¼‰å°†åœ¨CDNä¸­é…ç½®çš„æºç«™ï¼Œæ”¹ä¸ºWAFæä¾›çš„`CNAME`
  * è¯¥æ­¥éª¤å¾—åˆ°äº† CDNæä¾›çš„`CNAME`
* 3ã€é…ç½®DDoSé«˜é˜²IPï¼Œåœ¨æºç«™åŸŸåä¸­å¡«å…¥CDNæä¾›çš„CNAMEï¼Œæˆ–è€…ï¼ˆæœªå¯ç”¨CDNï¼Œé«˜é˜²IPç›´æ¥å›æºè‡³WAFæƒ…å†µä¸‹ï¼‰Webåº”ç”¨é˜²ç«å¢™æä¾›çš„CNAMEã€‚
  * è¯¥æ­¥éª¤å¾—åˆ°äº† é«˜é˜²IPæœåŠ¡æä¾›çš„`CNAME`
* 4ã€ä¿®æ”¹DNSè§£æçš„é…ç½®ï¼Œå°†åŸŸåè§£ææŒ‡å‘ é«˜é˜²IPæœåŠ¡æä¾›çš„`CNAME`
  * é…ç½®å®Œæˆ

### åŸºç¡€æ¦‚å¿µ

æ¥å…¥WAFåï¼ŒWAFä»£ç†äº†å…¬ç½‘æ‰€æœ‰çš„å®¢æˆ·ç«¯è¯·æ±‚(è¿‡æ»¤è®¿é—®æµé‡)ï¼Œå°†è¿‡æ»¤åçš„è®¿é—®æµé‡å¯¼å‘æºç«™ä¸šåŠ¡ç«¯å£

æ‰€ä»¥æºç«™ä¸šåŠ¡ç«¯å£æ”¶åˆ°çš„è®¿é—®æµé‡éƒ½æ˜¯æ¥è‡ªWAFçš„IP(è€ŒçœŸå®çš„å®¢æˆ·ç«¯IPåœ°å€åœ¨HTTPè¯·æ±‚å¤´éƒ¨çš„X-Forwarded-Forå­—æ®µä¸­)

å…¶ä¸­"WAFçš„æºIP"å°±æ˜¯å›æºIPåœ°å€(Return Source IP Address)

åœ¨æºç«™ä¸Šæ­£ç¡®è®¾ç½®"å›æºIPé˜²æŠ¤" ä»¥é¿å…æ”»å‡»è€…ç›´æ¥æ”»å‡»æºç«™IP ç­–ç•¥å¦‚ä¸‹:

1.å…è®¸WAFçš„IPæ®µè®¿é—®æºç«™çš„ä¸šåŠ¡ç«¯å£(80/443)
```
è§„åˆ™æ–¹å‘ï¼šå…¥æ–¹å‘
æˆæƒç­–ç•¥ï¼šå…è®¸
åè®®ç±»å‹ï¼šTCP
æˆæƒç±»å‹ï¼šåœ°å€æ®µè®¿é—®
ç«¯å£èŒƒå›´ï¼š80/443
æˆæƒå¯¹è±¡ï¼šæ‰€æœ‰Webåº”ç”¨é˜²ç«å¢™å›æºIPæ®µ
ä¼˜å…ˆçº§ï¼š1
```

2.ç¦æ­¢å…¬ç½‘IPè®¿é—®æºç«™çš„ä¸šåŠ¡ç«¯å£(80/443)
```
è§„åˆ™æ–¹å‘ï¼šå…¥æ–¹å‘
æˆæƒç­–ç•¥ï¼šæ‹’ç»
åè®®ç±»å‹ï¼šTCP
ç«¯å£èŒƒå›´ï¼š80/443
æˆæƒç±»å‹ï¼šåœ°å€æ®µè®¿é—®
æˆæƒå¯¹è±¡ï¼š0.0.0.0/0
ä¼˜å…ˆçº§ï¼š100
```

æ­¤æ—¶åˆ™åªæœ‰å…ˆç»è¿‡WAFï¼Œä»WAFå‡ºå£çš„æµé‡æ‰å¯ä»¥è®¿é—®åˆ°æºç«™çš„ä¸šåŠ¡ç«¯å£ã€‚

### WAF/CDN æ ¹æœ¬ç»•è¿‡æ–¹å¼1 - æ”»å‡»æºç«™IP

* å‰ç½®æ¡ä»¶:é’ˆå¯¹ç›®æ ‡å¿…é¡»æ˜¯ å¼€å¯äº†WAFä½†æ²¡æœ‰è®¾ç½®"å›æºIPé˜²æŠ¤"çš„ç«™ç‚¹ å¯æ‰¾åˆ°æºç«™IP(ç›´æ¥å¯¹æºç«™çš„çœŸå®ipå‘èµ·è¯·æ±‚,æµé‡ä¸ç»è¿‡WAF/CDN)
  * æ–¹å¼1 æŸ¥æ‰¾ç›¸å…³åŸŸåçš„Aè®°å½•
    * DNSå†å²è®°å½•(DNS history records) - æŸ¥çœ‹è¯¥åŸŸåDNSè§£æçš„å†å²è®°å½• ä¸»è¦æ˜¯Aè®°å½• (å¯èƒ½æ˜¯è¯¥ç«™æœ€å¼€å§‹æ²¡ä¸ŠWAF/CDNæ—¶çš„IP) å‚è€ƒå·¥å…·[vincentcox/bypass-firewalls-by-DNS-history](https://github.com/vincentcox/bypass-firewalls-by-DNS-history)
    * å­åŸŸåçš„Aè®°å½•
    * è¯¥å…¬å¸å…¶ä»–åŸŸåçš„Aè®°å½•
  * æ–¹å¼2 å…¶ä»–æœåŠ¡ - ä¸è¯¥åŸŸåçš„å…¶ä»–æœåŠ¡(éweb)è¿›è¡Œäº¤äº’
    * é‚®ä»¶æœåŠ¡ - è·å–åˆ°æºç«™IP(è®¾æ³•è®©ç›®æ ‡ç«™å‘é€é‚®ä»¶ï¼Œå¦‚å‘ä¸€ä¸ªä¸å­˜åœ¨çš„åœ°å€aCLa21lc@domain.comå‘é€é‚®ä»¶ï¼Œé€šå¸¸ä¼šæ”¶åˆ°å¤±è´¥åé¦ˆé‚®ä»¶ï¼Œä¸‹è½½é‚®ä»¶çš„.emlæºæ–‡ä»¶ï¼Œæ‰¾åˆ°å…¶ä¸­`Return-Path`å­—æ®µä¸­çš„IPåœ°å€ã€å­åŸŸå)
    * å°è¯•é€šè¿‡IPè®¿é—®ç›®æ ‡ å‘½ä»¤ `curl -k -H "Host: sub.domain.com" https://109.234.165.77`
  * æ–¹å¼3 å…¨ç½‘æ‰«æ - åˆ©ç”¨"ç½‘ç»œç©ºé—´å¼•æ“" åŒ¹é…ç½‘é¡µæ ‡é¢˜(title)
* ä¿®å¤æ–¹æ¡ˆ: åœ¨æºç«™ä¸Šæ­£ç¡®è®¾ç½®"å›æºIPé˜²æŠ¤" ä»¥é¿å…æ”»å‡»è€…ç›´æ¥æ”»å‡»æºç«™IP ç­–ç•¥å¦‚ä¸‹
  * 1.å…è®¸WAFçš„IPæ®µè®¿é—®æºç«™çš„ä¸šåŠ¡ç«¯å£(80/443)
  * 2.ç¦æ­¢å…¬ç½‘IPè®¿é—®æºç«™çš„ä¸šåŠ¡ç«¯å£(80/443)

### WAF æ ¹æœ¬ç»•è¿‡æ–¹å¼2 - ä½¿ç”¨WAFæ— æ³•è¯†åˆ«çš„TLSåŠ å¯†ç®—æ³•

* å‰ç½®æ¡ä»¶ - WAFå’ŒWebServeréƒ½é…æœ‰SSLè¯ä¹¦(è¿™ç§æƒ…å†µä¸å¸¸è§)
* æµé‡ç»è¿‡ - request -> WAF(é…æœ‰SSLè¯ä¹¦è§£å¯†æµé‡,è§£ä¸å¼€åˆ™æ”¾è¡Œ) -> WebServer(é…æœ‰SSLè¯ä¹¦è§£å¯†æµé‡)
* ç»•è¿‡åŸç† - TLS Client(æµè§ˆå™¨/curl)åœ¨TLSæ¡æ‰‹ç¬¬ä¸€æ­¥æ—¶å¯ä¸»åŠ¨é€‰æ‹©SL/TLS ciphers"åŠ å¯†ç®—æ³•",å¦‚æœæ‰¾åˆ°WAFä¸æ”¯æŒçš„åŠ å¯†ç®—æ³•(WAFæ”¾è¡Œ)ä¸”WebServeré…æœ‰SSLè¯ä¹¦æ”¯æŒè§£å¯†è¯¥åŠ å¯†ç®—æ³•,åˆ™è¯·æ±‚å¯ç»•è¿‡WAFç›´è¾¾WebServer

å‚è€ƒ[LandGrey/abuse-ssl-bypass-waf](https://github.com/LandGrey/abuse-ssl-bypass-waf)

### WAF - ç»•è¿‡è§„åˆ™

* WAFè¯†åˆ«
  * [Ekultek/WhatWaf: Detect and bypass web application firewalls and protection systems](https://github.com/Ekultek/WhatWaf)
* ç»•è¿‡è§„åˆ™
  * åˆ†å—ä¼ è¾“
  * `multipart/form-data`
  * ...
