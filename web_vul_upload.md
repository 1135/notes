### 简介

任意文件上传

### 漏洞危害

|安全等级|能否解析动态脚本|文件路径可控|文件名称可控|文件后缀可控|文件存储位置|漏洞危害|
|:--:|---|---|---|---|---|---|
|弱|1|0|0|1|同域|上传webshell文件|
|弱|0|0|0|1|同域|上传hmtl实现XSS|
|弱|0|1|1|1|同域|覆盖任意文件|
|强|0|0|0|0|不同域|无法直接利用|

* 上传功能本身无漏洞的情况下 只有文件内容可控 利用漏洞联合
  * (如果有)web中间件解析漏洞 + 上传文件(1.jpg) = getshell
  * (如果有)web逻辑越权 = 可遍历已有文件
  * (如果有)web应用本地文件包含漏洞 + 上传文件(1.php) = getshell
  * (如果有)web应用XSS因严格的CSP无法触发 + 上传文件(payload) = XSS(bypass CSP)

### 常规测试

* 上传 - filename fuzz
* 访问 - 遍历文件

### SDL - 防御与修复方案

* 0.基础 - 使用较新版本的web中间件(避免解析漏洞) 并禁止文件存储路径的web脚本解析(上传的文件只能作为数据)
* 1.文件后缀 - 白名单(图片jpg jpeg png)
* 2.文件名称 - 随机hash重命名(避免遍历文件)
* 3.保存路径 - 保存到固定文件夹(不能获取用户输入的路径 避免目录穿越)
* 4.文件位置 - 资源存储 与 web应用 建议不同域
* 5.文件复检 - (不强制要求)如果进行拉伸等图片处理失败 则为非正常图片(畸形构造)
* 6.对应记录 - 建立对应关系 每个文件都能够对应到实际上传者 便于追溯 鉴权
* 7.访问鉴权 - 有任意用户来访问上传的文件 都可以根据其权限(身份) 判断是否有权限访问 避免越权
* 综上 如在 `www.XXX.com` 上传的文件都保存到 `https://file.XXXcs.com/media/upload/picture/20191015162116-c21be4fc-ef24-1.png`
